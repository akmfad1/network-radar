FROM python:3.11-alpine

# Install system dependencies for ping/dig
RUN apk add --no-cache \
    iputils \
    bind-tools \
    libcap \
    curl

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt \
    --index-url https://mirror-pypi.runflare.com/simple/ \
    --trusted-host mirror-pypi.runflare.com

COPY agent.py .
COPY agent_config.yaml .

# Grant ping capability
RUN setcap cap_net_raw+ep /bin/ping || true

# Create non-root user
RUN adduser -D -s /bin/sh agent && chown -R agent:agent /app
USER agent

# Set Python to unbuffered mode for immediate log output
ENV PYTHONUNBUFFERED=1

CMD ["python", "-u", "agent.py"]
